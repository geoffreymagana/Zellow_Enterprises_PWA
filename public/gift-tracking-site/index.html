<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Gift from Zellow Enterprises</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3 { font-family: 'Poppins', sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-[#34A7C1]">Zellow Enterprises</h1>
            <p class="text-gray-500">Your gift is on its way!</p>
        </header>

        <main id="tracking-content">
            <!-- Loading State -->
            <div id="loading-state" class="text-center p-8 bg-white rounded-lg shadow-md">
                <p class="text-lg font-semibold animate-pulse">Loading your gift details...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden text-center p-8 bg-white rounded-lg shadow-md border-l-4 border-red-500">
                <h2 class="text-xl font-bold text-red-600 mb-2">Tracking Error</h2>
                <p id="error-message" class="text-gray-600">Could not find tracking details for this gift. Please check the link or contact the sender.</p>
            </div>

            <!-- Success State -->
            <div id="success-state" class="hidden space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-[#34A7C1] mb-3">A Special Gift For You!</h2>
                    <p class="text-gray-600">From: <strong id="sender-name" class="text-gray-800">A friend</strong></p>
                    <blockquote id="gift-message-container" class="hidden mt-4 border-l-4 border-gray-200 pl-4 italic text-gray-700">
                        <p id="gift-message-text"></p>
                    </blockquote>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3">Shipping Details</h3>
                    <div id="shipping-address-details" class="text-gray-600">
                        <!-- Shipping details will be populated here -->
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">Delivery Status</h3>
                    <div class="text-center mb-4">
                        <p class="text-sm text-gray-500">Current Status:</p>
                        <p id="current-status" class="text-xl font-bold capitalize text-[#33A67F]"></p>
                    </div>
                    <div id="estimated-delivery-date" class="text-sm text-center text-gray-500">
                         <!-- Estimated delivery will be populated here -->
                    </div>
                    <div id="tracking-history" class="mt-6 border-t pt-4">
                         <!-- History will be populated here -->
                    </div>
                </div>

                <div id="delivered-state" class="hidden text-center p-8 bg-green-50 rounded-lg shadow-md border-l-4 border-green-500">
                    <h2 class="text-xl font-bold text-green-700 mb-2">Your Gift Has Been Delivered!</h2>
                    <p class="text-gray-600">We hope you enjoy your special gift. Thank you for being a part of the Zellow family!</p>
                </div>
            </div>
        </main>

        <footer class="text-center mt-8 text-xs text-gray-500">
            <p>&copy; Zellow Enterprises. All rights reserved.</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDzUlYdqqdkTxcHJHChsX6zM-U_7N92xec",
            authDomain: "zellowlive.firebaseapp.com",
            projectId: "zellowlive",
            storageBucket: "zellowlive.appspot.com",
            messagingSenderId: "943761891650",
            appId: "1:943761891650:web:e8c12f77ea9d5edf0b68db",
            measurementId: "G-46MZ5BWTGD"
        };
        
        function showState(state) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-state').classList.add('hidden');
            document.getElementById('success-state').classList.add('hidden');
            if (document.getElementById(state)) {
                document.getElementById(state).classList.remove('hidden');
            }
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            showState('error-state');
        }

        try {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');

            if (!token) {
                showError("No gift tracking token provided. The link may be incomplete.");
                return;
            }

            const orderDocRef = doc(db, 'orders', token);

            const unsubscribe = onSnapshot(orderDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const orderData = docSnap.data();

                    if (!orderData.isGift || (orderData.isGift && orderData.giftDetails && orderData.giftDetails.recipientCanViewAndTrack === false)) {
                        showError("Access to tracking for this gift has been restricted by the sender.");
                        unsubscribe(); // Stop listening for updates
                        return;
                    }

                    // Populate UI
                    showState('success-state');
                    
                    document.getElementById('sender-name').textContent = orderData.customerName || 'A friend';

                    if (orderData.giftDetails && orderData.giftDetails.giftMessage) {
                        document.getElementById('gift-message-text').textContent = orderData.giftDetails.giftMessage;
                        document.getElementById('gift-message-container').classList.remove('hidden');
                    }
                    
                    if(orderData.shippingAddress){
                       const addr = orderData.shippingAddress;
                       document.getElementById('shipping-address-details').innerHTML = `<p>${addr.addressLine1}</p><p>${addr.city}, ${addr.county}</p>`;
                    }

                    if (orderData.shippingMethodName) {
                        document.getElementById('estimated-delivery-date').innerHTML = `<p>Shipping Method: <strong>${orderData.shippingMethodName}</strong></p>`;
                    }
                    
                    const status = orderData.status.replace(/_/g, ' ');
                    document.getElementById('current-status').textContent = status;

                    const historyContainer = document.getElementById('tracking-history');
                    historyContainer.innerHTML = '<h4>Tracking History</h4>';
                    if (orderData.deliveryHistory && Array.isArray(orderData.deliveryHistory)) {
                        const historyList = document.createElement('ul');
                        historyList.className = 'mt-2 space-y-2 text-xs text-gray-500';
                        orderData.deliveryHistory.slice().reverse().forEach(entry => {
                            const li = document.createElement('li');
                            const entryDate = entry.timestamp?.toDate ? entry.timestamp.toDate() : new Date();
                            const formattedDate = entryDate.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
                            li.innerHTML = `<span class="font-semibold text-gray-700 capitalize">${entry.status.replace(/_/g, ' ')}:</span> ${formattedDate}<br><span class="pl-2 text-gray-400">- ${entry.notes}</span>`;
                            historyList.appendChild(li);
                        });
                        historyContainer.appendChild(historyList);
                    }
                    
                    if (orderData.status === 'delivered') {
                        document.getElementById('delivered-state').classList.remove('hidden');
                    } else {
                        document.getElementById('delivered-state').classList.add('hidden');
                    }

                } else {
                    showError("This gift tracking link is invalid or the order could not be found.");
                }
            }, (error) => {
                console.error("Firestore error:", error);
                showError("A problem occurred while retrieving tracking details. Please try again later.");
            });

        } catch (e) {
            console.error("Initialization Error:", e);
            showError("Could not initialize tracking service.");
        }
    </script>
</body>
</html>
