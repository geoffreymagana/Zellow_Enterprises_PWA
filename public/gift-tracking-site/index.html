
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Zellow Gift</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use absolute paths for CSS and JS to ensure they are resolved correctly from the root -->
    <link rel="stylesheet" href="/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 font-inter">
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>
                    <h1 class="font-headline font-bold text-xl text-gray-800">Zellow Enterprises</h1>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-6 py-8">
            <div id="loading-state" class="text-center py-20">
                <svg class="animate-spin h-10 w-10 text-primary mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="text-gray-600">Loading your gift details...</p>
            </div>

            <div id="error-state" class="hidden text-center py-20">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-red-500"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" x2="12" y1="9" y2="13"></line><line x1="12" x2="12.01" y1="17" y2="17"></line></svg>
                <h2 class="text-2xl font-bold mb-2">Tracking Error</h2>
                <p id="error-message" class="text-gray-600">Could not find tracking details for this gift. Please check the link or contact the sender.</p>
                 <div id="config-error-help" class="hidden mt-4 text-xs text-left bg-red-50 p-3 rounded-md border border-red-200">
                    <p class="font-semibold">Developer Notice: Firebase Configuration Error</p>
                    <p>The gift tracking page cannot connect to Firebase because the configuration is missing. Please ensure you have replaced the placeholder values (like "YOUR_API_KEY") in <strong>public/gift-tracking-site/index.html</strong> with your actual Firebase project credentials as described in the README.md file.</p>
                </div>
            </div>

            <div id="success-state" class="hidden max-w-2xl mx-auto space-y-8">
                <div class="text-center">
                    <h2 class="text-3xl font-bold font-headline text-gray-800">A Special Gift For You!</h2>
                    <p class="text-lg text-gray-600 mt-1">From: <span id="sender-name" class="font-semibold text-primary">A friend</span></p>
                </div>
                
                <div id="gift-message-card" class="hidden bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <p id="gift-message" class="text-gray-700 italic text-center"></p>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">Order Status</h3>
                    <div class="flex items-center space-x-4">
                        <div class="bg-primary/10 p-3 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M5 18H3c-1.1 0-2-.9-2-2V8c0-1.1.9-2 2-2h3.54a2 2 0 0 1 1.79.88l1.44 2.16a2 2 0 0 0 1.79.88H18c1.1 0 2 .9 2 2v4c0 1.1-.9 2-2 2h-2"/><path d="M8 18V8"/><path d="M12 18V8"/><path d="M16 18V8"/></svg>
                        </div>
                        <div>
                            <p id="order-status" class="font-semibold text-xl capitalize"></p>
                            <p id="status-note" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                </div>

                <div id="items-card" class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">Your Gift Contains</h3>
                    <div id="items-list" class="space-y-4">
                        <!-- Items will be injected here -->
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="font-bold text-lg mb-2 text-gray-800">Shipping To</h3>
                        <div id="shipping-address" class="text-sm text-gray-600 space-y-0.5"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="font-bold text-lg mb-2 text-gray-800">Estimated Delivery</h3>
                        <p id="shipping-method" class="text-sm text-gray-600"></p>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 mt-auto">
            <div class="container mx-auto px-6 py-4 text-center text-gray-500 text-sm">
                &copy; <span id="footer-year"></span> Zellow Enterprises. All rights reserved.
            </div>
        </footer>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDzUlYdqqdkTxcHJHChsX6zM-U_7N92xec",
            authDomain: "zellowlive.firebaseapp.com",
            projectId: "zellowlive",
            storageBucket: "zellowlive.appspot.com",
            messagingSenderId: "943761891650",
            appId: "1:943761891650:web:e8c12f77ea9d5edf0b68db",
            measurementId: "G-46MZ5BWTGD"
        };
        
        // UI Elements
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessageEl = document.getElementById('error-message');
        const successState = document.getElementById('success-state');
        const senderNameEl = document.getElementById('sender-name');
        const giftMessageCardEl = document.getElementById('gift-message-card');
        const giftMessageEl = document.getElementById('gift-message');
        const orderStatusEl = document.getElementById('order-status');
        const statusNoteEl = document.getElementById('status-note');
        const itemsListEl = document.getElementById('items-list');
        const shippingAddressEl = document.getElementById('shipping-address');
        const shippingMethodEl = document.getElementById('shipping-method');
        const footerYearEl = document.getElementById('footer-year');
        const configErrorHelpEl = document.getElementById('config-error-help');
        
        footerYearEl.textContent = new Date().getFullYear();

        function showError(message, showConfigHelp = false) {
            loadingState.classList.add('hidden');
            successState.classList.add('hidden');
            errorState.classList.remove('hidden');
            errorMessageEl.textContent = message;
            if (showConfigHelp) {
                configErrorHelpEl.classList.remove('hidden');
            }
        }
        
        function showSuccess() {
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            successState.classList.remove('hidden');
        }

        async function fetchGiftDetails() {
            // 1. Verify Configuration
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_")) {
                showError("The tracking service is not configured correctly.", true);
                return;
            }

            // 2. Initialize Firebase
            let app;
            try {
                app = initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                showError("Could not connect to the tracking service.");
                return;
            }
            const db = getFirestore(app);

            // 3. Get Token (Order ID) from URL
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            if (!token) {
                showError("No tracking token found in the URL.");
                return;
            }

            // 4. Fetch Order from Firestore
            try {
                const orderRef = doc(db, "orders", token);
                const orderSnap = await getDoc(orderRef);

                if (!orderSnap.exists()) {
                    showError("Could not find tracking details for this gift. Please check the link.");
                    return;
                }
                
                const orderData = orderSnap.data();

                // 5. Security and Data Validation
                if (orderData.isGift !== true) {
                    showError("This order is not marked as a gift and cannot be tracked this way.");
                    return;
                }
                if (orderData.giftDetails?.recipientCanViewAndTrack === false) {
                     showError("The sender has disabled detailed tracking for this gift.");
                     return;
                }

                // 6. Populate UI
                senderNameEl.textContent = orderData.senderName || "A friend";
                
                if (orderData.giftDetails?.giftMessage) {
                    giftMessageEl.textContent = orderData.giftDetails.giftMessage;
                    giftMessageCardEl.classList.remove('hidden');
                }

                const lastHistory = orderData.deliveryHistory?.[orderData.deliveryHistory.length - 1];
                orderStatusEl.textContent = (lastHistory?.status || orderData.status || "Processing").replace(/_/g, ' ');
                statusNoteEl.textContent = lastHistory?.notes || `Last updated: ${new Date(orderData.updatedAt.seconds * 1000).toLocaleDateString()}`;

                itemsListEl.innerHTML = ''; // Clear previous items
                orderData.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center space-x-4';
                    const img = document.createElement('img');
                    img.src = item.imageUrl || 'https://placehold.co/64x64.png';
                    img.alt = item.name;
                    img.className = 'w-16 h-16 rounded-md object-cover bg-gray-100';
                    itemDiv.appendChild(img);
                    const nameDiv = document.createElement('div');
                    nameDiv.textContent = `${item.quantity} x ${item.name}`;
                    nameDiv.className = 'font-medium text-gray-800';
                    itemDiv.appendChild(nameDiv);
                    itemsListEl.appendChild(itemDiv);
                });

                if (orderData.shippingAddress) {
                    const addr = orderData.shippingAddress;
                    shippingAddressEl.innerHTML = `
                        <p class="font-medium">${addr.fullName}</p>
                        <p>${addr.addressLine1}</p>
                        ${addr.addressLine2 ? `<p>${addr.addressLine2}</p>` : ''}
                        <p>${addr.city}, ${addr.county}</p>
                    `;
                }

                shippingMethodEl.textContent = orderData.shippingMethodName || 'Standard Delivery';

                showSuccess();

            } catch (err) {
                console.error("Firestore Fetch Error:", err);
                showError("An error occurred while fetching your gift details. Please try again later.");
            }
        }

        // Run on page load
        fetchGiftDetails();
    </script>
</body>
</html>

    