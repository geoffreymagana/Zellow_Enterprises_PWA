<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Gift from Zellow Enterprises</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f8fa; /* A light, pleasant background */
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 1.25rem;
            bottom: -1.25rem;
            width: 2px;
            background-color: #e5e7eb; /* border-gray-200 */
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 1rem;
            top: 0.5rem;
            transform: translateX(-50%);
            width: 1rem;
            height: 1rem;
            border-radius: 9999px;
            background-color: white;
            border-width: 2px;
        }
        .timeline-dot-active {
            border-color: #34A7C1; /* primary color */
            background-color: #34A7C1;
        }
        .timeline-dot-inactive {
            border-color: #d1d5db; /* border-gray-300 */
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-state" class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
        <svg class="animate-spin h-12 w-12 text-[#34A7C1] mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-600">Loading your gift details...</p>
    </div>

    <div id="error-state" class="hidden flex-col items-center justify-center min-h-screen p-4 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        <h1 class="text-2xl font-bold text-gray-800">Tracking Error</h1>
        <p id="error-message" class="text-gray-600 mt-2">Could not retrieve gift details. The link may be invalid or tracking may be disabled.</p>
    </div>

    <main id="success-state" class="hidden min-h-screen">
        <div class="max-w-2xl mx-auto py-8 px-4">
            <div class="text-center mb-8">
                 <h1 class="text-3xl font-bold text-[#34A7C1]">A Special Gift For You!</h1>
                 <p class="text-gray-600">
                    <span id="sender-name" class="font-semibold">Your sender</span> has sent you something wonderful from Zellow Enterprises.
                 </p>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md space-y-6">
                <div id="gift-message-section" class="hidden">
                    <h2 class="text-lg font-semibold text-gray-800">A Message from the Sender:</h2>
                    <blockquote class="border-l-4 border-[#34A7C1] pl-4 py-2 mt-2 bg-gray-50 italic text-gray-700">
                        <p id="gift-message"></p>
                    </blockquote>
                </div>

                <div>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Delivery Status</h2>
                    <div id="timeline" class="relative pl-8 space-y-10">
                        <!-- Timeline items will be injected here -->
                    </div>
                </div>

                <div id="items-section" class="border-t pt-4">
                     <h2 class="text-lg font-semibold text-gray-800 mb-2">Gift Contents</h2>
                     <ul id="item-list" class="divide-y divide-gray-200">
                        <!-- Item list will be injected here -->
                     </ul>
                </div>
            </div>

            <footer class="text-center mt-8">
                <p class="text-sm text-gray-500">Have questions? Contact Zellow Enterprises support.</p>
            </footer>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };
        
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessageEl = document.getElementById('error-message');
        const successState = document.getElementById('success-state');

        function showError(message) {
            loadingState.classList.add('hidden');
            errorMessageEl.textContent = message;
            errorState.classList.remove('hidden');
        }

        // --- Step 1: Verify Firebase Configuration ---
        if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            console.error("Firebase config is not set up in public/gift-tracking-site/index.html");
            showError("This tracking page is not configured correctly. Please see the project's README.md for setup instructions regarding Firebase configuration.");
        } else {
            // --- Step 2: Initialize Firebase and fetch data ---
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                
                const urlParams = new URLSearchParams(window.location.search);
                const orderId = urlParams.get('token');

                if (!orderId) {
                    showError("No gift tracking token found in the URL.");
                } else {
                    const orderRef = doc(db, 'orders', orderId);

                    onSnapshot(orderRef, (docSnap) => {
                        loadingState.classList.add('hidden');

                        if (docSnap.exists()) {
                            const order = docSnap.data();
                            
                            if (!order.isGift || (order.giftDetails && !order.giftDetails.recipientCanViewAndTrack)) {
                                showError("This order is not a gift or the sender has disabled detailed tracking.");
                                return;
                            }
                            
                            successState.classList.remove('hidden');
                            errorState.classList.add('hidden');
                            
                            // Populate data
                            document.getElementById('sender-name').textContent = order.giftDetails?.senderName || order.customerName || 'A friend';
                            
                            const giftMessageSection = document.getElementById('gift-message-section');
                            const giftMessageEl = document.getElementById('gift-message');
                            if (order.giftDetails?.giftMessage) {
                                giftMessageEl.textContent = order.giftDetails.giftMessage;
                                giftMessageSection.classList.remove('hidden');
                            } else {
                                giftMessageSection.classList.add('hidden');
                            }
                            
                            // Render Timeline
                            const timelineContainer = document.getElementById('timeline');
                            timelineContainer.innerHTML = ''; // Clear previous timeline
                            if(order.deliveryHistory && order.deliveryHistory.length > 0) {
                                const history = [...order.deliveryHistory].reverse();
                                history.forEach((entry, index) => {
                                    const item = document.createElement('div');
                                    item.className = 'timeline-item relative';
                                    const dotClass = index === 0 ? 'timeline-dot-active' : 'timeline-dot-inactive';
                                    item.innerHTML = `
                                        <div class="timeline-dot ${dotClass}"></div>
                                        <div class="ml-8">
                                            <p class="font-semibold text-gray-800 capitalize">${entry.status.replace(/_/g, ' ')}</p>
                                            <p class="text-xs text-gray-500">${new Date(entry.timestamp.seconds * 1000).toLocaleString()}</p>
                                        </div>
                                    `;
                                    timelineContainer.appendChild(item);
                                });
                            }
                            
                            // Render Items
                            const itemListContainer = document.getElementById('item-list');
                            itemListContainer.innerHTML = '';
                             if (order.items && order.items.length > 0) {
                                order.items.forEach(item => {
                                    const li = document.createElement('li');
                                    li.className = 'py-3 flex items-center justify-between';
                                    li.innerHTML = `
                                        <div class="flex items-center">
                                            <img src="${item.imageUrl || 'https://placehold.co/48x48.png'}" alt="${item.name}" class="w-12 h-12 rounded-md object-cover mr-4 bg-gray-100">
                                            <div>
                                                <p class="font-semibold text-sm text-gray-800">${item.name}</p>
                                                <p class="text-xs text-gray-500">Quantity: ${item.quantity}</p>
                                            </div>
                                        </div>
                                    `;
                                    itemListContainer.appendChild(li);
                                });
                            }

                        } else {
                            showError("The gift tracking link is invalid or the order could not be found.");
                        }
                    }, (error) => {
                        console.error("Firestore snapshot error:", error);
                        showError("There was an error connecting to the tracking service. Please try again later.");
                    });
                }
            } catch (e) {
                console.error("Firebase initialization or query error:", e);
                showError("An unexpected error occurred while setting up the tracking page.");
            }
        }
    </script>
</body>
</html>
