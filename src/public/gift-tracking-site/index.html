
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Gift - Zellow Enterprises</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F8FA; /* HSL(195, 20%, 95%) */
        }
        .font-headline {
            font-family: 'Poppins', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }
    </style>
</head>
<body class="antialiased">

    <div id="loading-state" class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
        <svg class="animate-spin h-12 w-12 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-600">Loading your gift details...</p>
    </div>

    <div id="error-state" class="hidden flex-col items-center justify-center min-h-screen p-4 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        <h1 class="text-xl font-bold font-headline mb-2">Tracking Error</h1>
        <p id="error-message" class="text-gray-600 max-w-md">Could not find tracking details for this gift. Please check the link or contact the sender.</p>
    </div>

    <main id="success-state" class="hidden max-w-md mx-auto p-4 space-y-6">
        <section class="text-center py-6">
            <img src="https://www.gstatic.com/images/icons/material/system_gm/2x/delivery_dining_gm_blue_48dp.png" alt="Delivery scooter" class="w-24 h-24 mx-auto mb-4" data-ai-hint="delivery scooter"/>
            <h1 class="text-2xl font-bold font-headline" id="order-status-heading">Order Status</h1>
            <p class="text-gray-500" id="order-status-subheading">Your package is on its way</p>
        </section>

        <section id="gift-items-card" class="card">
            <div class="p-4 space-y-4" id="gift-items-container">
                <!-- Gift items will be injected here -->
            </div>
        </section>

        <section class="card">
             <div class="p-4">
                <h2 class="text-lg font-semibold font-headline mb-3">Order Summary</h2>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-500">From</span>
                        <span class="font-medium" id="sender-name">A friend</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Order ID</span>
                        <span class="font-medium" id="order-id"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Shipping Address</span>
                        <span class="font-medium text-right" id="shipping-address"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Estimated Delivery</span>
                        <span class="font-medium" id="estimated-delivery"></span>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="card">
             <div class="p-4">
                <h2 class="text-lg font-semibold font-headline mb-3">Tracking History</h2>
                <div class="space-y-3 text-xs" id="tracking-history-container">
                   <!-- History will be injected here -->
                </div>
            </div>
        </section>
    </main>

    <footer class="text-center py-6 text-sm text-gray-500">
        <p>&copy; <span id="year"></span> Zellow Enterprises. All rights reserved.</p>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDzUlYdqqdkTxcHJHChsX6zM-U_7N92xec",
            authDomain: "zellowlive.firebaseapp.com",
            projectId: "zellowlive",
            storageBucket: "zellowlive.appspot.com",
            messagingSenderId: "943761891650",
            appId: "1:943761891650:web:e8c12f77ea9d5edf0b68db",
            measurementId: "G-46MZ5BWTGD"
        };
        
        const loadingEl = document.getElementById('loading-state');
        const successEl = document.getElementById('success-state');
        const errorEl = document.getElementById('error-state');
        const errorMessageEl = document.getElementById('error-message');
        document.getElementById('year').textContent = new Date().getFullYear();

        function showState(state) {
            loadingEl.classList.add('hidden');
            successEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            if (state === 'success') successEl.classList.remove('hidden');
            else if (state === 'error') errorEl.classList.remove('hidden');
            else loadingEl.classList.remove('hidden');
        }

        async function fetchGiftDetails() {
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);

                const params = new URLSearchParams(window.location.search);
                const token = params.get('token');

                if (!token) {
                    errorMessageEl.textContent = "No gift tracking token provided in the URL.";
                    showState('error');
                    return;
                }

                const orderRef = doc(db, "orders", token);
                const orderSnap = await getDoc(orderRef);

                if (!orderSnap.exists()) {
                    errorMessageEl.textContent = `No gift order found with the ID: ${token.substring(0,8)}...`;
                    showState('error');
                    return;
                }

                const order = orderSnap.data();

                if (order.isGift !== true) {
                    errorMessageEl.textContent = "This order is not marked as a gift and cannot be tracked publicly.";
                    showState('error');
                    return;
                }
                
                if (order.giftDetails?.recipientCanViewAndTrack === false) {
                     errorMessageEl.textContent = "The sender has disabled detailed tracking for this gift.";
                    showState('error');
                    return;
                }

                // Populate UI
                document.getElementById('sender-name').textContent = order.giftDetails?.recipientName || 'A friend'; // Shows the recipient's name not sender
                document.getElementById('order-status-heading').textContent = order.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                const statusSubheadings = {
                    pending: 'Your gift is being prepared.',
                    processing: 'Your gift is being customized.',
                    out_for_delivery: 'Your gift is on the way!',
                    delivered: 'Your gift has been delivered!',
                    cancelled: 'This gift order has been cancelled.',
                    default: 'Your gift is in process.'
                };
                document.getElementById('order-status-subheading').textContent = statusSubheadings[order.status] || statusSubheadings.default;


                const itemsContainer = document.getElementById('gift-items-container');
                itemsContainer.innerHTML = '';
                order.items.forEach(item => {
                    const itemHtml = `
                        <div class="flex items-center gap-4">
                            <img src="${item.imageUrl || 'https://placehold.co/64x64.png'}" alt="${item.name}" class="w-16 h-16 rounded-md object-cover bg-gray-100 flex-shrink-0" data-ai-hint="gift item"/>
                            <div class="flex-grow">
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-500">Quantity: ${item.quantity}</p>
                            </div>
                        </div>
                    `;
                    itemsContainer.innerHTML += itemHtml;
                });

                document.getElementById('order-id').textContent = orderSnap.id.substring(0, 12) + '...';
                document.getElementById('shipping-address').textContent = `${order.shippingAddress.addressLine1}, ${order.shippingAddress.city}`;
                document.getElementById('estimated-delivery').textContent = order.shippingMethodName || 'Standard Delivery';
                
                const historyContainer = document.getElementById('tracking-history-container');
                historyContainer.innerHTML = '';
                if (order.deliveryHistory && order.deliveryHistory.length > 0) {
                    order.deliveryHistory.slice().reverse().forEach(entry => {
                         const entryDate = entry.timestamp?.toDate ? entry.timestamp.toDate() : new Date();
                         const formattedDate = entryDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                         const formattedTime = entryDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

                        const historyHtml = `
                             <div class="flex gap-4">
                                <div class="flex flex-col items-center">
                                    <div class="w-3 h-3 rounded-full bg-blue-500 mt-1"></div>
                                    <div class="w-px flex-grow bg-gray-200"></div>
                                </div>
                                <div>
                                    <p class="font-medium capitalize">${entry.status.replace(/_/g, ' ')}</p>
                                    <p class="text-gray-500">${formattedDate} at ${formattedTime}</p>
                                </div>
                            </div>
                        `;
                        historyContainer.innerHTML += historyHtml;
                    });
                } else {
                    historyContainer.innerHTML = '<p class="text-gray-500">No tracking history available yet.</p>';
                }


                showState('success');

            } catch (error) {
                console.error("Error fetching gift details:", error);
                errorMessageEl.textContent = "An unexpected error occurred while fetching gift details. Please try again later.";
                showState('error');
            }
        }

        fetchGiftDetails();

    </script>
</body>
</html>
`